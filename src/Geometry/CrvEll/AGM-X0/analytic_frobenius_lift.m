////////////////////////////////////////////////////////////////////////
//                                                                    //
//                            David Kohel                             //
//                 AGM-X0(N) Analytic Lifting Functions               //
//                                                                    //
////////////////////////////////////////////////////////////////////////

import "modular_correspondences.m" : PhiX0;

function AnalyticAGMProduct(N,n)
    case N:
    when 2:
        c := 
            [
            [ 1 ],
            [],
            [],
            [],
            [ -48 ],
            [],
            [],
            [],
            [ 2304 ],
            [],
            [],
            [],
            [ -4096 ],
            [],
            [],
            [],
            [ 5701632 ],
            [],
            [],
            [],
            [ -28311552 ],
            [],
            [],
            [],
            [],
            [ 1845493760 ],
            [],
            [],
            [ -113548197888 ],
            []
            ];
        e := 
            [
            [ 2 ],
            [],
            [],
            [],
            [ 1 ],
            [],
            [],
            [],
            [ 2 ],
            [],
            [],
            [],
            [ 3 ],
            [],
            [],
            [],
            [ 4 ],
            [],
            [],
            [],
            [ 5 ],
            [],
            [],
            [],
            [],
            [ 6 ],
            [],
            [],
            [ 7 ],
            []
            ];
    when 3:
        c := 
            [
            [ 1 ],
            [],
            [ -36 ],
            [ 1026 ],
            [],
            [ 9720 ],
            [],
            [ 1051947 ],
            [],
            [ 9998964, 93927276 ],
            [],
            [],
            [ 10237679424, 1204441407729 ],
            [],
            [ 10485875125584 ],
            [ 199707657158790 ],
            [],
            []
            ];
        e := 
            [
            [ 3 ],
            [],
            [ 1 ],
            [ 2 ],
            [],
            [ 3 ],
            [],
            [ 4 ],
            [],
            [ 5, 6 ],
            [],
            [],
            [ 7, 8 ],
            [],
            [ 9 ],
            [ 10 ],
            [],
            []
            ];
    when 4:
        c := 
            [
            [ 1 ],
            [],
            [],
            [],
            [ -16, 240 ],
            [],
            [],
            [],
            [],
            [ -3584, -3584 ],
            [],
            [],
            [ 13029376 ],
            [ -8192 ],
            [],
            [],
            [ 23003136, 79364096 ],
            [],
            [],
            [],
            [ 16130244608 ],
            [ -1142947840 ],
            [],
            [],
            [ -329521299456, 172678069616640 ],
            [],
            [],
            [],
            [ 255525589614592, 2189113423822848 ],
            []
            ];
        e := 
            [
            [ 2 ],
            [],
            [],
            [],
            [ 1, 2 ],
            [],
            [],
            [],
            [],
            [ 3, 4 ],
            [],
            [],
            [ 6 ],
            [ 5 ],
            [],
            [],
            [ 7, 8 ],
            [],
            [],
            [],
            [ 10 ],
            [ 9 ],
            [],
            [],
            [ 11, 12 ],
            [],
            [],
            [],
            [ 13, 14 ],
            []
            ];
    when 5:
        c := 
            [
            [ 1 ],
            [ -30, 585 ],
            [ -9400, -146850 ],
            [ -713250, 87438500 ],
            [ 2760783750, 28269399375 ],
            [ 113402862500, 644012784375 ],
            [ -124730895375000, 5676373418500000 ],
            [],
            [ 221235630208593750, 10012876431465234375,
            165910675082567187500, 1124068996955272265625 ],
            [ 4983813291973640625000, -313287979085919113281250 ],
            [ 757521335118780230185546875 ],
            [ 12291236670671272851562500, 13418481251050945595410156250,
            139001822619438194402929687500 ],
            [ 172172269853540979688476562500,
            30223876486571136479207275390625 ]
            ];
        e := 
            [
            [ 5 ],
            [ 1, 2 ],
            [ 3, 4 ],
            [ 5, 6 ],
            [ 7, 8 ],
            [ 9, 10 ],
            [ 11, 12 ],
            [],
            [ 13, 14, 15, 16 ],
            [ 17, 18 ],
            [ 20 ],
            [ 19, 21, 22 ],
            [ 23, 24 ]
            ];
    when 7:
        c := [
            [ 1 ],
            [ -28, 462, -5824, 61705 ],
            [ -575064, -11275390, -86909144, -316615264 ],
            [ -508741716, 330450650768, 12968142035296, 227091056598987 ],
            [ 2324017066686112, 14985679520285362, 60912373421904872,
            147255139154249112 ],
            [ 182623317826756856, 337333362400574890,
            -336227891797005243448, 96002763911702873300320 ],
            [ 8339600561672138823755992, 317075158294001981901374130, 
            6650247265574885784015527568, 86629570285044728695517229193 ],
            [ 742153530345501165364498002096,
            9642657081076655286763179145652, 
            85456538772622182827099502935920,
            543527937080260087606706566870219 ],
            [ 2552563901624589711021558368127224,
            8566006231206679396537616809285466, 
            21460074411631763619805320105341400 ],
            [ -743535873022172383570041003140302156, 
            218120898307255879668465574640541335264, 
            20799643274577677024954943091829131470468, 
            867661028766560073384664118350097855544832 ]
            ];
        e := [
            [ 7 ],
            [ 1, 2, 3, 4 ],
            [ 5, 6, 7, 8 ],
            [ 9, 10, 11, 12 ],
            [ 13, 14, 15, 16 ],
            [ 17, 18, 19, 20 ],
            [ 21, 22, 23, 24 ],
            [ 25, 26, 27, 28 ],
            [ 29, 30, 31 ],
            [ 32, 33, 34, 35 ]
            ];
    when 8:
        c := 
            [
            [ 1 ],
            [],
            [],
            [ 8 ],
            [ 80 ],
            [],
            [],
            [],
            [ 256 ],
            [ 8704 ],
            [],
            [],
            [ 45056, 536576 ],
            [],
            [],
            [],
            [ 155648000 ],
            [ 7733248 ],
            [],
            [],
            [ 1395654656, 19840106496 ],
            [],
            [],
            [],
            [ 292376543232, 3755328143360 ],
            [],
            [],
            [],
            [ 796413906649088 ],
            [ 53647899623424 ]
            ];
        e := 
            [
            [ 2 ],
            [],
            [],
            [ 2 ],
            [ 4 ],
            [],
            [],
            [],
            [ 6 ],
            [ 8 ],
            [],
            [],
            [ 10, 12 ],
            [],
            [],
            [],
            [ 16 ],
            [ 14 ],
            [],
            [],
            [ 18, 20 ],
            [],
            [],
            [],
            [ 22, 24 ],
            [],
            [],
            [],
            [ 28 ],
            [ 26 ]
            ];
    when 9:
        c := [
            [ 1 ],
            [],
            [ -9, -252 ],
            [ 54, 649674 ],
            [ 5265 ],
            [ 486, 33048, 2925234, 98492517 ],
            [],
            [ -284310, 95057955, 746944318962 ],
            [ 2721811167, 1628537873607 ],
            [ 167507325289521 ],
            [ 19730337615, -14931128309481, 11007827988715881 ],
            [ 9071347984480242, 2485532229845377635 ],
            [ 138174660, 20255812587593298, 295146811991132679753, 737634586607673209106147 ],
            [ 139584431011691609073 ],
            [ 5816757370191771585663, 672520772701802138031131661 ],
            [ 3617112905878878247401252, 81601158598822347121410156, 335951317483041428622992268072 ],
            [ 38394987838149953214747 ],
            [ 6284320843086515446947432834930 ]
            ];
        e := [
            [ 3 ],
            [],
            [ 1, 3 ],
            [ 2, 6 ],
            [ 4 ],
            [ 3, 5, 7, 9 ],
            [],
            [ 6, 8, 12 ],
            [ 10, 13 ],
            [ 15 ],
            [ 11, 14, 16 ],
            [ 18, 19 ],
            [ 9, 17, 21, 24 ],
            [ 20 ],
            [ 22, 27 ],
            [ 25, 26, 30 ],
            [ 23 ],
            [ 31 ]
            ];
    when 13:
        c := [
            [ 1 ],
            [ -26, 351, -3224, 22165, -117546, 468013, -1169792,
            25898470, -168725687, 687023064, -1695680194, 28091872042 ],
            [ -561249, -30714549086, -428755206802, -4348371100359,
            -27548699217598, 138599607472950, 5699009810586170,
            774062321245391178, 5865092557705744415, 36612906614488201010,
            199897137248937103144, 1073213480542420436570, 
            6391816768712682760310, 125068087775895091246991 ],
            [ -14592474, -182405925, -1430062452, -7763196168,
            -93805559458, 75504441118991144, 22005262189507538391190,
            -257135994332195516650242, -10810977852741121511604408, 
            -111882924783713892330044250, -803534103652073776215815712, 
            -327909174757129450356145872, -228089098077119065346208549420, 
            -2446131030911565820818723583986,
            -22721516863939025459394880905014, 
            -180572358964570266565041111277232,
            -944586327853941703168970678954488, 
            8890310695721082291077159129715929 ],
            [ -62962662616179134931066230299,
            84468487524789674697884520025239774, 
            1265452820609788725112542448868395944,
            105096874918964642386182095850622644052, 
            795915192516502885406601092403397707850,
            5787190810755164178974934524823976185746, 
            44186847561690627558944312108971442525286, 
            262996911499563347164976431156100366810330, 
            1491656965814972965067096015934281457566292, 
            6577926766003034643223732295138493650871915, 
            24373334791987927467322469252931202730052836, 
            1051447475676456084887323044635429322894648030, 
            4649273459273183568054296791398698410112784151, 
            335863088915542444393262143259243905338193568317 ],
            [ -8190011440026, -102375143000325, -802621121122548,
            -500849535399421806, -5602515736989734550,
            -50180322585622327020, -384700687816611454938, 
            -1985289527849976953280, 35568927610534196704449, 
            12449718277366241073127745395926624872,
            78464466444800747971348839386050235396953250,
            3484324022164501540218937429892176740428015663502, 
            32280576767758500003517023486317468747483995407535, 
            243162382976272968047801960076889018106888388110322, 
            2468567555951427903437981014222633798219550871263014, 
            8343367042644536152194459449954749959367354915734854, 
            51164167548656011116969071102454909693096274042685118, 
            538803805577882552217498649963709126430512224627435322, 
            4366442535501802160567114904189209277059757389395188452, 
            24057037863823738364233824780560861824558703213524519308, 
            1312487346557553116046773803004808886210267811714293122668, 
            13350625388925334206634211622564886392907971253251901030694 ],
            [ 15918762596988261764465656611041223136130912472, 
            125384155199076997067423656318543669458255362704062523148, 
            125582562375463639866582728095880630655003166902096529243382, 
            1187994766617686170923884925463060093553937651358759492327867, 
            38766483595149742065437305346943079441396731696193909112429245, 
            151336794777312617607876494371548939865815527572964755700686470, 
            161326188487275800932312381498583710444205090561159965963751217, 
            -14502413840955599971119773598054796412057919241999119533099628764, 
            -229600784585293468418266704297725146994706648472157623768963202926, 
            -22193331667622698857657312273659784572257186442653413995681471763863, 
            -181829504643128057592902794406536012032200835661594795648832733995404, 
            -10930809153416265295199792561227048378557963807328153222455782631140876, 
            -69455087333865777663841670237987845864509794960915190537154248297742270 ],
            [ 8012867809735825188696812780984982880270885271766806246564216, 
            -1653257431023191790205461606347968046194030989729463675838957750100, 
            -1402222137310569105273969905568592721472196587622783430131738927611326, 
            -289562882918263274329739099233044897357236458003244095634534256990882972, 
            -293966415329116730851976651234781182162868640589758687861145826404856983, 
            16950235010208100909904422432055820252096804496602444935566284434070191014, 
            464881234024221657924610856977912133058071596415546127000742575675383017639, 
            3647569440343421889794346232997481253176875752701708243989101145927682468196, 
            38998959421123091114575614754931284511828656955007143972036338892909639689089, 
            367265535931991771765741451244108345946685278124773676071557435562211541942600, 
            3072404080832657703392563299405855050264705731088988866844164320799868030777378,
            24908358146058779430536190658540136015553850817431414597203054634712158385456402, 
            184444694663896679786334474708141814969071092067827437520063173958301604126044418, 
            1283769723585344960708262195955395112607665383818052610332137435280988667595699830,
            8500723687946685396800531071818850964224720440432255527514431937460203902926490190,
            56100767097006121807566246997685581832841742035247738272058796339972944159973297494,
            313803444549564604687286250052349369953378310740595165004392278101395173407386482591 ]
            ];
        e := [
            [ 13 ],
            [ 1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 14 ],
            [ 8, 13, 15, 16, 17, 18, 19, 21, 22, 23, 24, 25, 26, 28 ],
            [ 9, 10, 11, 12, 14, 20, 27, 29, 30, 31, 32, 33, 35, 36,
            37, 38, 39, 40 ],
            [ 34, 41, 42, 44, 45, 46, 47, 48, 49, 50, 51, 53, 54, 56 ],
            [ 17, 18, 19, 22, 23, 24, 25, 26, 28, 43, 52, 57, 58, 59,
            60, 61, 62, 63, 64, 65, 67, 68 ],
            [ 55, 66, 69, 70, 72, 73, 74, 75, 76, 78, 79, 81, 82 ],
            [ 71, 77, 80, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93,
            94, 95, 96 ]
            ];
    when 16:
        c := [
            [ 1 ],
            [],
            [ 4 ],
            [],
            [],
            [ 32 ],
            [ 192 ],
            [],
            [ 2816 ],
            [],
            [ 25600 ],
            [],
            [ 323584 ],
            [],
            [ 4014080 ],
            [],
            [ 56950784 ],
            [],
            [],
            [],
            [ 705691648 ],
            [],
            [ 134490357760 ],
            [ 10007609344 ],
            [ 1935771959296 ],
            [],
            [ 26845089103872 ],
            [],
            [],
            [ 392648594554880 ]
            ];
        e := [
            [ 2 ],
            [],
            [ 4 ],
            [],
            [],
            [ 8 ],
            [ 12 ],
            [],
            [ 16 ],
            [],
            [ 20 ],
            [],
            [ 24 ],
            [],
            [ 28 ],
            [],
            [ 32 ],
            [],
            [],
            [],
            [ 36 ],
            [],
            [ 44 ],
            [ 40 ],
            [ 48 ],
            [],
            [ 52 ],
            [],
            [],
            [ 56 ]
            ];
    when 25:
        c := [
            [ 1 ],
            [ -5, 10, 120, -590 ],
            [ -50, -825, -1850, 600350, 1789925, -75602150, 30599407150 ],
            [ -250, -500, 9500, 1162750, -131141500, -711533250,
            88854843500, 547482543000, 2945432282375, -5419168578752750 ],
            [ 145000, 3466250, -2243352500, 2134552092500,
            -1343389838750, -117801884126875, 22320405957891250,
            2354651797998768125, -3146290673447264103750 ],
            [ -206250, -487500, 32850000, -3356096875, -12966018750,
            -96725446190625, -210371136987500, 635341643534375,
            248232922664700000, 873097481037978125, 25183988334948209375, 
            16324247392478565625, 3093377194810720394581250,
            -729931276630641707448206250 ],
            [ -320581968843750, -1122653576257022843750,
            -10786355054912498484375, 4073464036663680593750, 
            53430769369744754328125, 990695582388937857015625,
            6797997018766297053703125, -5118035585142557538968750,
            -1195723925102399771028296875, 2913817233770711323305890625, 
            38221891900163528998137671875,
            -56585991122401121177117769312500 ],
            [ 23380000000, 7289375000, 3753241909062500,
            15458020179985078125, -4476398143032673002577968750,
            -369268475297473918993891171875,
            4194323170696897674147533515625,
            -976722882167660042956388338359375,
            -7442200278664474549781189985390625 ],
            [ -51562500, -121875000, -22310323772424061229687500,
            -256545069632289886747656250, -11517057238844638577548437500,
            16946401892402674735976713281250,
            -5559299425946161459148073046875,
            -29061288956814997709299355950390625,
            1485825565752096761758066000587109375,
            3418275535931085508216488055157812500, 
            -1088662603610746501402646797029635546875,
            -1283387540123866527541595837554935937500, 
            -21389099482793312995347213013208991406250,
            58287884173964373746377847950510909186328125 ],
            [ 714914062500, -5646234375000, 8843164574218750,
            1179711034601562500, -4161478159734775895165226968750000,
            11424803102619419304443917729601562500,
            8505309177278526464537557131947265625,
            -43475564858423031689627379602898437500, 
            109158915554451280164020245689663861328125,
            93377284623949160428864587737172970703125, 
            147193052361300880742046636125994917335937500,
            -250667394372732349618686576801769626683593750, 
            -62785364766310741406823894119955956558302734375, 
            34774790030278459289260014949152054893309890625000 ],
            [ 983506948558554687500,
            78809237600603627972115463994140625, 
            -5555636672734221153597976535596513671875,
            -9373544968159261072821426774757578125000, 
            5158931114521812311427488552382570371093750,
            14176240378660035220169253915732057792968750, 
            -5216965840303157943432966553690976128701171875, 
            -12598048792297197485452584818081850871943359375, 
            -36661309333028046530975822392689069173505859375, 
            214578119233685330671918938536431814041445312500, 
            -6937112309004530825259116641083211926013076171875, 
            -22771700228583544381863309822686417680279853515625, 
            -9626168939391816146060238114793005887111867744140625, 
            4585903757373293491087747742680429415576928507246093750 ],
            [ 7768759375000000, -1319860856505047167968750,
            -62337364725436298437500000, 
            2704779083677366154220671293900149214387158203125, 
            -701315114546910884460886473316101844133119482421875, 
            -2624455959562075767631016112288550061366506542968750, 
            25157002913393482261715513848953854946479196689843750000, 
            90213835971665866319363914039750797195815894442089843750, 
            -3809804347147302513400379859079376589723147017550097656250, 
            3022120937636334715741319788645726050833399432468118261718750 ],
            [ 12901183593750000, -169495174804687500,
            -2252608576171875000, -3366697511718750000,
            5354077444903125575375556034080673612685058593750, 
            -14083539770954509855052240456415349308205076660156250, 
            -63095791660007206467513322657459981335073627685546875, 
            61489882300286586797447069801132746455064482910156250, 
            1177576775694855432036182811935206204801371780517578125, 
            41684425533463685624879134011191467524257783959472656250, 
            -25736514107547487725942269772020968278411992860975585937500, 
            -69686938985332880732468625310295049176302563046395996093750, 
            14256105238143212795806659439792842221614372794579143310546875, 
            42155976857746707409895214828307405376141439531561309326171875, 
            -1730766998535892947669323766147357525477661017322503890625000000, 
            93741321646031251017895165674427533955277966629069868494384765625 ]
            ];
        e := [
            [ 5 ],
            [ 1, 2, 5, 10 ],
            [ 4, 6, 7, 11, 12, 15, 20 ],
            [ 5, 8, 9, 14, 16, 17, 21, 22, 25, 30 ],
            [ 10, 13, 19, 23, 24, 31, 32, 35, 40 ],
            [ 11, 12, 15, 18, 20, 26, 28, 29, 33, 34, 36, 37, 45, 50 ],
            [ 27, 39, 41, 42, 43, 44, 46, 47, 51, 52, 55, 60 ],
            [ 21, 22, 30, 38, 53, 56, 57, 61, 62 ],
            [ 16, 17, 48, 49, 54, 58, 59, 63, 66, 67, 71, 72, 75, 80 ],
            [ 24, 25, 31, 35, 64, 68, 69, 70, 76, 77, 81, 82, 85, 90 ],
            [ 40, 65, 73, 74, 78, 79, 83, 84, 86, 87, 91, 92, 95, 100 ],
            [ 32, 45, 50, 88, 93, 94, 101, 102, 105, 110 ],
            [ 33, 34, 36, 37, 89, 96, 97, 98, 99, 104, 106, 107,
            111, 112, 115, 120 ]
            ];
    else
        assert false;
    end case;
    return c[1..n], e[1..n];
end function;

function AnalyticAGMLift(N,x)
    R := Parent(x);
    prec := Precision(R);
    _, p := IsPrimePower(N);
    cffs, exps := AnalyticAGMProduct(N,prec);
    P := PolynomialRing(Integers()); X := P.1; 
    for i in [1..prec] do
        x := ChangePrecision(R,Max(2,i))!x;
        xpow := [x];
        for j in [1..Max(&cat exps[1..i])-1] do
            Append(~xpow,x*xpow[j]);
        end for;
        y := x^p;
        for j in [2..i] do
            if #cffs[j] ne 0 then
                y *:= 1 + &+[
                    cffs[j][k]*xpow[exps[j][k]] : k in [1..#exps[j]] ];
            end if;
        end for;
        x := y;
        vprint AGM, 3 :
            "Analytic val:", Valuation(PhiX0(N,x,FrobeniusImage(x)));
    end for;
    return x;
end function;

