////////////////////////////////////////////////////////////////////////
//                                                                    //
//                            David Kohel                             //
//                Modular Correspondences for the AGM                 //
//                                                                    //
////////////////////////////////////////////////////////////////////////

forward PhiX0;

////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////

intrinsic AGMModularCorrespondence(N::RngIntElt,p::RngIntElt)
    -> RngMPolElt
    {The modular correspondencee on X_0(N) use for AGM recursion.}
    P := PolynomialRing(Integers(),2 : Global := true);
    return PhiX0(N,p,P.1,P.2);
end intrinsic;

////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////

intrinsic ReciprocalClassicalModularPolynomial(p::RngIntElt)
    -> RngMPolElt
    {}
    P<X,Y> := PolynomialRing(Integers(),2 : Global := true);
    if p eq 2 then
	return
	    -157464000000000*X^3*Y^3 + 8748000000*X^3*Y^2 - 162000*X^3*Y
	    + X^3 + 8748000000*X^2*Y^3 + 40773375*X^2*Y^2 + 1488*X^2*Y
	    - 162000*X*Y^3 + 1488*X*Y^2 - X*Y + Y^3;
    elif p eq 3 then
	return
	    - X*Y
	    + 2232*X^2*Y + 2232*X*Y^2
	    + 2587918086*X^2*Y^2
	    - 770845966336000000*X^3*Y^3 
	    - 1069956*X*Y^3 - 1069956*X^3*Y 
	    + 36864000*X^4*Y + 36864000*X*Y^4
	    + 452984832000000*X^4*Y^2 + 452984832000000*X^2*Y^4
	    + 8900222976000*X^3*Y^2 + 8900222976000*X^2*Y^3
	    + 1855425871872000000000*X^4*Y^3 + 1855425871872000000000*X^3*Y^4
	    + X^4 + Y^4;
	    /*
    elif p eq 5 then
    return
    */
    end if; 
    return Numerator(Evaluate(ClassicalModularPolynomial(p),[1/X,1/Y]));
end intrinsic;    

function PhiX0(N,p,x,y)
    if N eq 1 then
	Phi := ReciprocalClassicalModularPolynomial(p);
	return Evaluate(Phi,[x,y]);
    end if;
    case [N,p]:
    when [2,2]:
        return x^2-(4096*y+48)*x*y-y;
    when [4,2]: 
        return x^2-(16*(16*x*y+x+y)+1)*y;
    when [8,2]: 
        return x^2*(4*y+1)^2-y;
    when [16,2]:
        return x^2*(4*y^2+1)-y;
    when [3,3]:
        xy := x*y;
        return x^3 - 531441*xy^2*y - 26244*xy^2
            - 270*x*xy - 729*xy*y - 36*xy - y;
    when [9,3]:
        return x^3 - 729*x^2*y^3 - 243*x^2*y^2 - 27*x^2*y
            - 243*x*y^3 - 81*x*y^2 - 9*x*y - 27*y^3 - 9*y^2 - y;
    when [5,5]:
        return x^5 - 244140625*x^4*y^5 - 58593750*x^4*y^4
            - 4921875*x^4*y^3 - 162500*x^4*y^2 - 1575*x^4*y
            - 1953125*x^3*y^4 - 468750*x^3*y^3 - 39375*x^3*y^2
            - 1300*x^3*y - 15625*x^2*y^3 - 3750*x^2*y^2
            - 315*x^2*y - 125*x*y^2 - 30*x*y - y;
    when [25,5]:
        return x^5 - 625*x^4*y^5 - 625*x^4*y^4 - 375*x^4*y^3
            - 125*x^4*y^2 - 25*x^4*y - 625*x^3*y^5 - 625*x^3*y^4
            - 375*x^3*y^3 - 125*x^3*y^2 - 25*x^3*y - 375*x^2*y^5
            - 375*x^2*y^4 - 225*x^2*y^3 - 75*x^2*y^2 - 15*x^2*y
            - 125*x*y^5 - 125*x*y^4 - 75*x*y^3 - 25*x*y^2 - 5*x*y
            - 25*y^5 - 25*y^4 - 15*y^3 - 5*y^2 - y;
    when [7,7]: 
        return x^7 - 13841287201*x^6*y^7 - 7909306972*x^6*y^6
            - 1856265922*x^6*y^5 - 224003696*x^6*y^4 - 14201915*x^6*y^3
            - 422576*x^6*y^2 - 4018*x^6*y - 282475249*x^5*y^6
            - 161414428*x^5*y^5 - 37882978*x^5*y^4 - 4571504*x^5*y^3
            - 289835*x^5*y^2 - 8624*x^5*y - 5764801*x^4*y^5
            - 3294172*x^4*y^4 - 773122*x^4*y^3 - 93296*x^4*y^2
            - 5915*x^4*y - 117649*x^3*y^4 - 67228*x^3*y^3
            - 15778*x^3*y^2 - 1904*x^3*y - 2401*x^2*y^3
            - 1372*x^2*y^2 - 322*x^2*y - 49*x*y^2
            - 28*x*y - y;
    when [13,13]:
        return x^13 - 23298085122481*x^12*y^13
            - 46596170244962*x^12*y^12 - 44804009850925*x^12*y^11
            - 27020264402404*x^12*y^10 - 11283187332872*x^12*y^9
            - 3409754413780*x^12*y^8 - 758378576462*x^12*y^7
            - 123855918940*x^12*y^6 - 14548002326*x^12*y^5
            - 1174999540*x^12*y^4 - 59916584*x^12*y^3
            - 1623076*x^12*y^2 - 15145*x^12*y
            - 1792160394037*x^11*y^12 - 3584320788074*x^11*y^11
            - 3446462296225*x^11*y^10 - 2078481877108*x^11*y^9
            - 867937487144*x^11*y^8 - 262288801060*x^11*y^7
            - 58336813574*x^11*y^6 - 9527378380*x^11*y^5
            - 1119077102*x^11*y^4 - 90384580*x^11*y^3
            - 4608968*x^11*y^2 - 124852*x^11*y
            - 137858491849*x^10*y^11 - 275716983698*x^10*y^10
            - 265112484325*x^10*y^9 - 159883221316*x^10*y^8
            - 66764422088*x^10*y^7 - 20176061620*x^10*y^6
            - 4487447198*x^10*y^5 - 732875260*x^10*y^4
            - 86082854*x^10*y^3 - 6952660*x^10*y^2 - 354536*x^10*y
            - 10604499373*x^9*y^10 - 21208998746*x^9*y^9
            - 20393268025*x^9*y^8 - 12298709332*x^9*y^7
            - 5135724776*x^9*y^6 - 1552004740*x^9*y^5
            - 345188246*x^9*y^4 - 56375020*x^9*y^3
            - 6621758*x^9*y^2 - 534820*x^9*y - 815730721*x^8*y^9
            - 1631461442*x^8*y^8 - 1568712925*x^8*y^7
            - 946054564*x^8*y^6 - 395055752*x^8*y^5
            - 119384980*x^8*y^4 - 26552942*x^8*y^3 - 4336540*x^8*y^2
            - 509366*x^8*y - 62748517*x^7*y^8 - 125497034*x^7*y^7
            - 120670225*x^7*y^6 - 72773428*x^7*y^5 - 30388904*x^7*y^4
            - 9183460*x^7*y^3 - 2042534*x^7*y^2 - 333580*x^7*y
            - 4826809*x^6*y^7 - 9653618*x^6*y^6 - 9282325*x^6*y^5
            - 5597956*x^6*y^4 - 2337608*x^6*y^3 - 706420*x^6*y^2
            - 157118*x^6*y - 371293*x^5*y^6 - 742586*x^5*y^5
            - 714025*x^5*y^4 - 430612*x^5*y^3 - 179816*x^5*y^2
            - 54340*x^5*y - 28561*x^4*y^5 - 57122*x^4*y^4
            - 54925*x^4*y^3 - 33124*x^4*y^2 - 13832*x^4*y
            - 2197*x^3*y^4 - 4394*x^3*y^3 - 4225*x^3*y^2
            - 2548*x^3*y - 169*x^2*y^3 - 338*x^2*y^2
            - 325*x^2*y - 13*x*y^2 - 26*x*y - y;
    end case;
    error "N must be in {2,3,4,5,7,8,9,13,16,25} not " * Sprint(N);
end function;

function DxPhiX0(N,p,x,y)
    if N eq 1 then
        Phi := ClassicalModularPolynomial(p);
        return Evaluate(Derivative(Phi,1),[x,y]);
    end if;
    case [N,p]:
    when [2,2]:
        return 2*(x-(2048*y+24)*y);
    when [4,2]: 
        return 2*(x-(128*y+8)*y);
    when [8,2]: 
        return 2*x*(4*y+1)^2;
    when [16,2]:
        return 2*x*(4*y^2+1);
    when [3,3]:
        return 3*x^2 - 1062882*x*y^3 - 52488*x*y^2
            - 540*x*y - 729*y^2 - 36*y;
    when [9,3]:
        return 3*x^2 - 1458*x*y^3 - 486*x*y^2 - 54*x*y
            - 243*y^3 - 81*y^2 - 9*y;
    when [5,5]:
        return 5*x^4 - 976562500*x^3*y^5 - 234375000*x^3*y^4
            - 19687500*x^3*y^3 - 650000*x^3*y^2 - 6300*x^3*y
            - 5859375*x^2*y^4 - 1406250*x^2*y^3 - 118125*x^2*y^2
            - 3900*x^2*y - 31250*x*y^3 - 7500*x*y^2 - 630*x*y
            - 125*y^2 - 30*y;
    when [25,5]:
        return 5*x^4 - 2500*x^3*y^5 - 2500*x^3*y^4 - 1500*x^3*y^3
            - 500*x^3*y^2 - 100*x^3*y - 1875*x^2*y^5 - 1875*x^2*y^4
            - 1125*x^2*y^3 - 375*x^2*y^2 - 75*x^2*y - 750*x*y^5
            - 750*x*y^4 - 450*x*y^3 - 150*x*y^2 - 30*x*y - 125*y^5 
            - 125*y^4 - 75*y^3 - 25*y^2 - 5*y;
    when [7,7]:
        return 7*x^6 - 83047723206*x^5*y^7 - 47455841832*x^5*y^6
            - 11137595532*x^5*y^5 - 1344022176*x^5*y^4
            - 85211490*x^5*y^3 - 2535456*x^5*y^2 - 24108*x^5*y
            - 1412376245*x^4*y^6 - 807072140*x^4*y^5 - 189414890*x^4*y^4
            - 22857520*x^4*y^3 - 1449175*x^4*y^2 - 43120*x^4*y
            - 23059204*x^3*y^5 - 13176688*x^3*y^4 - 3092488*x^3*y^3
            - 373184*x^3*y^2 - 23660*x^3*y - 352947*x^2*y^4
            - 201684*x^2*y^3 - 47334*x^2*y^2 - 5712*x^2*y
            - 4802*x*y^3 - 2744*x*y^2 - 644*x*y - 49*y^2 - 28*y;
    when [13,13]:
        return 13*x^12 - 279577021469772*x^11*y^13
            - 559154042939544*x^11*y^12 - 537648118211100*x^11*y^11
            - 324243172828848*x^11*y^10 - 135398247994464*x^11*y^9
            - 40917052965360*x^11*y^8 - 9100542917544*x^11*y^7
            - 1486271027280*x^11*y^6 - 174576027912*x^11*y^5
            - 14099994480*x^11*y^4 - 718999008*x^11*y^3
            - 19476912*x^11*y^2 - 181740*x^11*y
            - 19713764334407*x^10*y^12 - 39427528668814*x^10*y^11
            - 37911085258475*x^10*y^10 - 22863300648188*x^10*y^9
            - 9547312358584*x^10*y^8 - 2885176811660*x^10*y^7
            - 641704949314*x^10*y^6 - 104801162180*x^10*y^5
            - 12309848122*x^10*y^4 - 994230380*x^10*y^3
            - 50698648*x^10*y^2 - 1373372*x^10*y
            - 1378584918490*x^9*y^11 - 2757169836980*x^9*y^10
            - 2651124843250*x^9*y^9 - 1598832213160*x^9*y^8
            - 667644220880*x^9*y^7 - 201760616200*x^9*y^6
            - 44874471980*x^9*y^5 - 7328752600*x^9*y^4
            - 860828540*x^9*y^3 - 69526600*x^9*y^2 - 3545360*x^9*y
            - 95440494357*x^8*y^10 - 190880988714*x^8*y^9
            - 183539412225*x^8*y^8 - 110688383988*x^8*y^7
            - 46221522984*x^8*y^6 - 13968042660*x^8*y^5
            - 3106694214*x^8*y^4 - 507375180*x^8*y^3 - 59595822*x^8*y^2
            - 4813380*x^8*y - 6525845768*x^7*y^9
            - 13051691536*x^7*y^8 - 12549703400*x^7*y^7
            - 7568436512*x^7*y^6 - 3160446016*x^7*y^5
            - 955079840*x^7*y^4 - 212423536*x^7*y^3 - 34692320*x^7*y^2
            - 4074928*x^7*y - 439239619*x^6*y^8 - 878479238*x^6*y^7
            - 844691575*x^6*y^6 - 509413996*x^6*y^5 - 212722328*x^6*y^4
            - 64284220*x^6*y^3 - 14297738*x^6*y^2 - 2335060*x^6*y
            - 28960854*x^5*y^7 - 57921708*x^5*y^6 - 55693950*x^5*y^5
            - 33587736*x^5*y^4 - 14025648*x^5*y^3 - 4238520*x^5*y^2
            - 942708*x^5*y - 1856465*x^4*y^6 - 3712930*x^4*y^5
            - 3570125*x^4*y^4 - 2153060*x^4*y^3 - 899080*x^4*y^2
            - 271700*x^4*y - 114244*x^3*y^5 - 228488*x^3*y^4
            - 219700*x^3*y^3 - 132496*x^3*y^2 - 55328*x^3*y
            - 6591*x^2*y^4 - 13182*x^2*y^3 - 12675*x^2*y^2
            - 7644*x^2*y - 338*x*y^3 - 676*x*y^2 - 650*x*y
            - 13*y^2 - 26*y;
    end case;
    error "N must be in {2,3,4,5,7,8,9,13,16,25} not " * Sprint(N);
end function;

function DyPhiX0(N,p,x,y)
    if N eq 1 then
        Phi := ClassicalModularPolynomial(p);
        return Evaluate(Derivative(Phi,2),[x,y]);
    end if;
    case [N,p]:
    when [2,2]:
        return -(8192*x*y+48*x+1);
    when [4,2]: 
        return -(512*x*y+16*x+32*y+1);
    when [8,2]: 
        return (32*y+8)*x^2-1;
    when [16,2]:
        return 8*x^2*y-1;
    when [3,3]:
        return -(1594323*(x*y)^2 + 52488*x^2*y
            + 270*x^2 + 1458*x*y + 36*x + 1);
    when [9,3]:
        return -(2187*x^2*y^2 + 486*x^2*y + 27*x^2
            + 729*x*y^2 + 162*x*y + 9*x + 81*y^2 + 18*y + 1);
    when [5,5]:
        return -1220703125*x^4*y^4 - 234375000*x^4*y^3 - 14765625*x^4*y^2
            - 325000*x^4*y - 1575*x^4 - 7812500*x^3*y^3 - 1406250*x^3*y^2 
            - 78750*x^3*y - 1300*x^3 - 46875*x^2*y^2 - 7500*x^2*y 
            - 315*x^2 - 250*x*y - 30*x - 1;
    when [25,5]:
        return -3125*x^4*y^4 - 2500*x^4*y^3 - 1125*x^4*y^2 - 250*x^4*y
            - 25*x^4 - 3125*x^3*y^4 - 2500*x^3*y^3 - 1125*x^3*y^2
            - 250*x^3*y - 25*x^3 - 1875*x^2*y^4 - 1500*x^2*y^3
            - 675*x^2*y^2 - 150*x^2*y - 15*x^2 - 625*x*y^4 - 500*x*y^3
            - 225*x*y^2 - 50*x*y - 5*x - 125*y^4 - 100*y^3 - 45*y^2
            - 10*y - 1;
    when [7,7]:
        return -96889010407*x^6*y^6 - 47455841832*x^6*y^5
            - 9281329610*x^6*y^4 - 896014784*x^6*y^3
            - 42605745*x^6*y^2 - 845152*x^6*y - 4018*x^6
            - 1694851494*x^5*y^5 - 807072140*x^5*y^4
            - 151531912*x^5*y^3 - 13714512*x^5*y^2
            - 579670*x^5*y - 8624*x^5 - 28824005*x^4*y^4
            - 13176688*x^4*y^3 - 2319366*x^4*y^2 - 186592*x^4*y
            - 5915*x^4 - 470596*x^3*y^3 - 201684*x^3*y^2
            - 31556*x^3*y - 1904*x^3 - 7203*x^2*y^2
            - 2744*x^2*y - 322*x^2 - 98*x*y - 28*x - 1;
    when [13,13]:
        return -302875106592253*x^12*y^12 - 559154042939544*x^12*y^11
            - 492844108360175*x^12*y^10 - 270202644024040*x^12*y^9
            - 101548685995848*x^12*y^8 - 27278035310240*x^12*y^7
            - 5308650035234*x^12*y^6 - 743135513640*x^12*y^5
            - 72740011630*x^12*y^4 - 4699998160*x^12*y^3
            - 179749752*x^12*y^2 - 3246152*x^12*y - 15145*x^12
            - 21505924728444*x^11*y^11 - 39427528668814*x^11*y^10
            - 34464622962250*x^11*y^9 - 18706336893972*x^11*y^8
            - 6943499897152*x^11*y^7 - 1836021607420*x^11*y^6
            - 350020881444*x^11*y^5 - 47636891900*x^11*y^4
            - 4476308408*x^11*y^3 - 271153740*x^11*y^2 - 9217936*x^11*y
            - 124852*x^11 - 1516443410339*x^10*y^10
            - 2757169836980*x^10*y^9 - 2386012358925*x^10*y^8
            - 1279065770528*x^10*y^7 - 467350954616*x^10*y^6
            - 121056369720*x^10*y^5 - 22437235990*x^10*y^4
            - 2931501040*x^10*y^3 - 258248562*x^10*y^2
            - 13905320*x^10*y - 354536*x^10 - 106044993730*x^9*y^9
            - 190880988714*x^9*y^8 - 163146144200*x^9*y^7
            - 86090965324*x^9*y^6 - 30814348656*x^9*y^5
            - 7760023700*x^9*y^4 - 1380752984*x^9*y^3
            - 169125060*x^9*y^2 - 13243516*x^9*y - 534820*x^9
            - 7341576489*x^8*y^8 - 13051691536*x^8*y^7
            - 10980990475*x^8*y^6 - 5676327384*x^8*y^5
            - 1975278760*x^8*y^4 - 477539920*x^8*y^3 - 79658826*x^8*y^2
            - 8673080*x^8*y - 509366*x^8 - 501988136*x^7*y^7
            - 878479238*x^7*y^6 - 724021350*x^7*y^5 - 363867140*x^7*y^4
            - 121555616*x^7*y^3 - 27550380*x^7*y^2 - 4085068*x^7*y
            - 333580*x^7 - 33787663*x^6*y^6 - 57921708*x^6*y^5
            - 46411625*x^6*y^4 - 22391824*x^6*y^3 - 7012824*x^6*y^2
            - 1412840*x^6*y - 157118*x^6 - 2227758*x^5*y^5
            - 3712930*x^5*y^4 - 2856100*x^5*y^3 - 1291836*x^5*y^2
            - 359632*x^5*y - 54340*x^5 - 142805*x^4*y^4
            - 228488*x^4*y^3 - 164775*x^4*y^2 - 66248*x^4*y - 13832*x^4
            - 8788*x^3*y^3 - 13182*x^3*y^2 - 8450*x^3*y - 2548*x^3
            - 507*x^2*y^2 - 676*x^2*y - 325*x^2 - 26*x*y - 26*x - 1;
    end case;
    error "N must be in {2,3,4,5,7,8,9,13,16,25} not " * Sprint(N);
end function;

